version: "3.9"

services:
  jobmanager:
    image: flink:1.20.0-scala_2.12-java17
    container_name: jobmanager
    hostname: jobmanager
    ports:
      - "8081:8081" # Flink Web UI
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager

  taskmanager:
    image: flink:1.20.0-scala_2.12-java17
    container_name: taskmanager
    hostname: taskmanager
    depends_on:
      - jobmanager
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 2

  job-submitter:
    image: flink:1.20.0-scala_2.12-java17
    container_name: job-submitter
    depends_on:
      - jobmanager
      - taskmanager
    volumes:
      - ./flink-java-jobs/build/libs:/jars
    entrypoint: >
      /bin/sh -c "
      sleep 10 &&
      flink run -m jobmanager:8081 /jars/facerec2-1.0-SNAPSHOT-all.jar
      "
